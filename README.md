# Bkash Integration with Laravel


### Step 1: Transaction initiation
Create transaction record in database with payment status as pending and other details.
Which will include with new invoice id, amount, currency, intent, payer reference, etc.


### Step 2: Generate Bkash authentication token
- Transaction initiation requires an authentication token from Bkash API. This token is generated by sending a POST request to Bkash API with the following parameters provided by Bkash:
    - app_key
    - app_secret
    - username
    - password 
- Make request to Bkash API to get authentication token.
- Update token in database for future use in transaction record.
```php
    $request_header = [
            'accept' => 'application/json',
            'content-type' => 'application/json',
            'password' => "Your Bkash Password",
            'username' => "Your Bkash Username",
    ];
    $request_body = [
        'app_key' => "Your Bkash App Key",
        'app_secret' => "Your Bkash App Secret",
    ];
    $response = Http::withHeaders($request_header)->post("https://checkout.sandbox.bka.sh/v1.2.0-beta/checkout/token/grant", $request_body);
    if ($response->successful()) {
        $response_body = json_decode($response->body());
        $token = (isset($response_body->id_token)) ? $response_body->id_token : false;
    } else {
        $token = false;
    }
```
### Step 3: Create payment request
- After getting the authentication token, create a payment request by sending a POST request to Bkash API with the following parameters:
    - mode (0011)
    - callbackURL (URL to which Bkash will send payment status)
    - amount (amount to be paid)
    - currency (like BDT)
    - intent (like sale, authorize, capture)
    - merchantInvoiceNumber (unique invoice id)
    - payerReference (Your Payer Reference, if any)
```php
    $request_header = [
        'Content-Type' => 'application/json',
        'authorization' => "Your Bkash Token",
        'x-app-key' => "Your Bkash App Key",
    ];
    $request_body = [
        "mode" => "0011",
        "callbackURL" =>  "Your Callback URL",
        'amount' => $amount,
        'currency' => $currency,
        'intent' => $intent,
        'merchantInvoiceNumber' => $invoice_id,
        "payerReference" => "Your Payer Reference, if any",
    ];
    $response = Http::withHeaders($request_header)->post("https://checkout.sandbox.bka.sh/v1.2.0-beta/checkout/payment/create", $request_body);
    return ($response->successful()) ? json_decode($response->body()) : false;
```
Response will be like below:
```php
{
    "paymentID": "TR0011rPCSAif1711513154680"
    "bkashURL": "https://sandbox.payment.bkash.com/?paymentId=TR0011rPCSAif1711513154680&hash=f(qh-cTfPjB4MWj8PY8(Ch3JZ4KHcVcEpmMGsgYpx9p)TAk4M5SDxURRJegxtFf)O)3BOi0)aVR.f4)9bXbawvS9ja!3D-l0MNTG1711513154680&mode=0011&apiVersion=v1.2.0-beta"
    "callbackURL": "YOUR-APP-BASE-URL/payments/bkash/url-based/callback/cf70db141e"
    "successCallbackURL": "YOUR-APP-BASE-URL/payments/bkash/url-based/callback/cf70db141e?paymentID=TR0011rPCSAif1711513154680&status=success"
    "failureCallbackURL": "YOUR-APP-BASE-URL/payments/bkash/url-based/callback/cf70db141e?paymentID=TR0011rPCSAif1711513154680&status=failure"
    "cancelledCallbackURL": "YOUR-APP-BASE-URL/payments/bkash/url-based/callback/cf70db141e?paymentID=TR0011rPCSAif1711513154680&status=cancel"
    "amount": "100"
    "intent": "sale"
    "currency": "BDT"
    "paymentCreateTime": "2024-03-27T10:19:14:680 GMT+0600"
    "transactionStatus": "Initiated"
    "merchantInvoiceNumber": "cf70db141e"
    "statusCode": "0000"
    "statusMessage": "Successful"
}

```
### Step 4: Redirect to Bkash payment page
- After creating the payment request, Bkash will return a payment URL. Redirect the user to this URL to complete the payment.
```php
    return redirect($response_body->bkashURL);
```
### Step 5: Payment execution and callback handling
- After the user completes the payment, Bkash will send a payment status to the callback URL provided in the payment request.
- Handle the payment execution in the callback URL controller method.
```php
    $request_header = [
        'Content-Type' => 'application/json',
        'authorization' => "Your Bkash Token",
        'x-app-key' => "Your Bkash App Key",
    ];
    $request_body = [
        "paymentID" => "Your Bkash Payment ID",
    ];
    $response = Http::withHeaders($request_header)->post("https://checkout.sandbox.bka.sh/v1.2.0-beta/checkout/payment/execute", $request_body);
    return ($response->successful()) ? json_decode($response->body()) : false;
```
Response will be like below:
```php
{
    "statusCode": "Bkash Status Code",
    "statusMessage": "Bkash Status Message",
}
```
### Step 6: Payment verification & update transaction status
- Fetch payment status from Bkash API with same `$request_header` and `$request_body`.
```php
    $request_header = [
        'Content-Type' => 'application/json',
        'authorization' => "Your Bkash Token",
        'x-app-key' => "Your Bkash App Key",
    ];
    $request_body = [
        "paymentID" => "Your Bkash Payment ID",
    ];
    $response = Http::withHeaders($request_header)->get("https://checkout.sandbox.bka.sh/v1.2.0-beta/checkout/payment/query");
    return ($response->successful()) ? json_decode($response->body()) : false;
```
Response will be like below:
```php
{
    "paymentID": "Bkash Payment ID"
    "mode": "Bkash Mode"
    "paymentCreateTime": "Bkash Payment Create Time"
    "paymentExecuteTime": "Bkash Payment Execute Time"
    "amount": "100"
    "intent": "sale"
    "currency": "BDT"
    "merchantInvoice": "cf70db141e"
    "transactionStatus": "Initiated or Completed"
    "verificationStatus": "Incomplete or Complete"
    "payerReference": "111111111"
    "statusCode": "Bkash Status Code",
    "statusMessage": "Bkash Status Message",
}
```
- Update the transaction record in the database with the payment status received from Bkash.

Author: